<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì„ ì› í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body { font-family: 'Pretendard', sans-serif; margin: 0; background: #f5f5f5; color: #333; }
        
        /* ë‹¤í¬ëª¨ë“œ */
        body.dark-mode { background: #121212; color: #eee; }
        body.dark-mode header { background: #1f1f1f; border-bottom: 1px solid #333; }
        body.dark-mode .card { background: #1e1e1e; border: 1px solid #333; }
        body.dark-mode input, body.dark-mode textarea { background: #2c2c2c; color: #fff; border: 1px solid #444; }

        /* í—¤ë” */
        header { background: #003366; color: #fff; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        header h2 { margin: 0; font-size: 1.1rem; }

        /* ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆ */
        .container { max-width: 600px; margin: 0 auto; padding: 10px; }
        
        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ (ì„¹ì…˜ ëŒ€ì²´) */
        .card { background: #fff; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card h3 { margin-top: 0; border-bottom: 2px solid #003366; padding-bottom: 8px; color: #003366; font-size: 1rem; }
        body.dark-mode .card h3 { color: #4fc3f7; border-color: #4fc3f7; }

        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        input, textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        textarea { height: 80px; resize: none; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button { width: 100%; padding: 12px; background: #003366; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        button:hover { background: #002244; }
        .mini-btn { width: auto; padding: 4px 8px; font-size: 12px; margin-left: 5px; }
        .btn-del { background: #c0392b; }
        .mode-btn { width: auto; background: rgba(255,255,255,0.2); padding: 6px 12px; font-size: 0.8rem; }

        /* ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ */
        ul { list-style: none; padding: 0; margin: 0; }
        .post-item { border-bottom: 1px solid #eee; padding: 10px 0; }
        .post-header-row { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .post-body-content { display: none; margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 4px; white-space: pre-wrap; }
        
        /* ëª¨ë‹¬ (ë¡œê·¸ì¸ íŒì—…ìš©) */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 20px; border-radius: 10px; width: 80%; max-width: 300px; text-align: center; }
        .modal-content h4 { margin-top: 0; color: #003366; }
    </style>
</head>

    <body>
    <header>
        <h2>ğŸš¢ ì„ ì› í†µí•© ê´€ë¦¬</h2>
        <button class="mode-btn" onclick="toggleDarkMode()">ğŸŒ™ ëª¨ë“œ</button>
    </header>

    <div class="container">
        
        <div class="card">
            <h3>ğŸ“¢ ê³µì§€ì‚¬í•­ (ê´€ë¦¬ì)</h3>
            <input id="noticeTitle" placeholder="ì œëª©">
            <textarea id="noticeContent" placeholder="ë‚´ìš©"></textarea>
            <button onclick="addNotice()">ê³µì§€ ë“±ë¡</button>
            <ul id="noticeList"></ul>
        </div>

        <div class="card">
            <h3>ğŸ’¬ ìµëª… ê²Œì‹œíŒ</h3>
            <input id="postTitle" placeholder="ì œëª©">
            <textarea id="postContent" placeholder="ë‚´ìš©"></textarea>
            <input id="postPw" type="password" placeholder="ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ (í•„ìˆ˜)">
            <button onclick="addPost()">ê¸€ ë“±ë¡</button>
            <ul id="boardList"></ul>
        </div>

        <div class="card">
            <h3>ğŸš¢ ì„ ë°• ì •ë³´</h3>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input id="shipSearch" placeholder="ì„ ë°•ëª… ê²€ìƒ‰..." oninput="filterShips()">
            </div>
            <div style="background:#f9f9f9; padding:10px; border-radius:6px; border:1px dashed #ccc;">
                <input id="shipName" placeholder="ì„ ë°•ëª… (ë“±ë¡ìš©)">
                <textarea id="shipOnboard" placeholder="ìŠ¹ì„  ì •ë³´ ì…ë ¥"></textarea>
                <button onclick="addShipInfo()" style="background:#27ae60;">ì„ ë°• ì •ë³´ ë“±ë¡/ìˆ˜ì •</button>
            </div>
            <ul id="shipList"></ul>
        </div>

        <div class="card">
            <h3>ğŸ“‚ ìë£Œì‹¤</h3>
            <input id="fileTitle" placeholder="ìë£Œ ì œëª©">
            <input type="file" id="fileInput">
            <button onclick="uploadFile()" style="background:#e67e22;">íŒŒì¼ ì—…ë¡œë“œ</button>
            <ul id="fileList"></ul>
        </div>

        <div class="card">
            <h3>ğŸ“… ìŠ¤ë§ˆíŠ¸ ê·¼ë¬´ì¼ì§€</h3>
            
            <input id="logDate" type="date" style="text-align:center; font-weight:bold;">
            <div style="display:flex; gap:5px;">
                <input type="number" id="logDay" placeholder="ì£¼ê°„(H)" step="0.5">
                <input type="number" id="logNight" placeholder="ì•¼ê°„(H)" step="0.5">
            </div>
            <textarea id="logMemo" placeholder="ì‘ì—… ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            
            <button onclick="trySaveWorkLog()" style="background:#d32f2f;">ë‚´ìš© ì €ì¥í•˜ê¸°</button>
            
            <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                <h4 style="margin:0 0 10px 0;">ğŸ“‹ ì €ì¥ëœ ê¸°ë¡</h4>
                <ul id="workLogList"></ul>
            </div>
        </div>

    </div>

    <div id="loginModal" class="modal-overlay">
        <div class="modal-content">
            <h4>ğŸ” ë³¸ì¸ í™•ì¸ ë° ì„¤ì •</h4>
            <p style="font-size:0.85rem; color:#666; margin-bottom:10px;">
                ì²˜ìŒì´ë©´ ë‹‰ë„¤ì„ê³¼ ë¹„ë²ˆì´ <strong>ìë™ ì„¤ì •</strong>ë˜ê³ ,<br>
                ê¸°ì¡´ íšŒì›ì´ë©´ <strong>ë¡œê·¸ì¸</strong> ë©ë‹ˆë‹¤.
            </p>
            <input id="modalNick" placeholder="ë‹‰ë„¤ì„ (ì˜ˆ: í™ê¸¸ë™)">
            <input id="modalPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬">
            <button onclick="confirmLoginAndSave()">í™•ì¸ ë° ì €ì¥</button>
            <button onclick="closeModal()" style="background:#888; margin-top:5px;">ì·¨ì†Œ</button>
        </div>
    </div>

      <script>
    // ğŸ”¥ ì‚¬ìš©ìë‹˜ì˜ Firebase ì„¤ì •ê°’ ì ìš© ì™„ë£Œ ğŸ”¥
    const firebaseConfig = { 
        apiKey: "AIzaSyBDXy5HcYW-IZQJ9ZDEivr_yi99AxhYme8", 
        authDomain: "my-app-d8527.firebaseapp.com", 
        projectId: "my-app-d8527", 
        storageBucket: "my-app-d8527.firebasestorage.app", 
        messagingSenderId: "667323279185", 
        appId: "1:667323279185:web:cff6184aaa82e08d345570" 
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    let allShipsData = [], filteredShips = [];
    let currentWorkerId = null; // ë¡œê·¸ì¸ ìƒíƒœ ë³€ìˆ˜

    /* ========== 1. ìŠ¤ë§ˆíŠ¸ ê·¼ë¬´ì¼ì§€ ë¡œì§ (í•µì‹¬) ========== */
    
    // (1) ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
    function trySaveWorkLog() {
        const date = document.getElementById('logDate').value;
        const day = document.getElementById('logDay').value;
        const night = document.getElementById('logNight').value;
        const memo = document.getElementById('logMemo').value;

        // í•„ìˆ˜ ì…ë ¥ í™•ì¸
        if(!date) return alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
        if(!day && !night && !memo) return alert("ê·¼ë¬´ ì‹œê°„ì´ë‚˜ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        // ë¡œê·¸ì¸ì´ ë˜ì–´ ìˆë‹¤ë©´ ë°”ë¡œ ì €ì¥
        if(currentWorkerId) {
            saveLogToDB();
        } else {
            // ë¡œê·¸ì¸ì´ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ëª¨ë‹¬ì°½ ë„ì›€
            document.getElementById('loginModal').style.display = 'flex';
        }
    }

    // (2) ëª¨ë‹¬ì°½ì—ì„œ 'í™•ì¸ ë° ì €ì¥' í´ë¦­ ì‹œ ì‹¤í–‰
    async function confirmLoginAndSave() {
        const nick = document.getElementById('modalNick').value.trim();
        const pw = document.getElementById('modalPw').value.trim();

        if(!nick || !pw) return alert("ë‹‰ë„¤ì„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        try {
            const userRef = db.collection('workers').doc(nick);
            const doc = await userRef.get();

            if(doc.exists) {
                // ê¸°ì¡´ íšŒì› -> ë¹„ë°€ë²ˆí˜¸ í™•ì¸
                if(doc.data().password === pw) {
                    currentWorkerId = nick;
                    alert(`ë°˜ê°‘ìŠµë‹ˆë‹¤, ${nick}ë‹˜! ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    closeModal();
                    saveLogToDB(); // ë¡œê·¸ì¸ ì„±ê³µ í›„ ì¦‰ì‹œ ì €ì¥
                    loadMyLogs();  // ë‚´ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
                } else {
                    alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                }
            } else {
                // ì‹ ê·œ íšŒì› -> ê°€ì… í›„ ì €ì¥
                await userRef.set({
                    password: pw,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                currentWorkerId = nick;
                alert(`í™˜ì˜í•©ë‹ˆë‹¤! '${nick}'ë‹˜ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                closeModal();
                saveLogToDB(); // ê°€ì… ì„±ê³µ í›„ ì¦‰ì‹œ ì €ì¥
                loadMyLogs();
            }
        } catch(e) {
            console.error(e);
            alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
        }
    }

    // (3) ì‹¤ì œ DBì— ì €ì¥í•˜ëŠ” í•¨ìˆ˜
    function saveLogToDB() {
        if(!currentWorkerId) return;

        const date = document.getElementById('logDate').value;
        const data = {
            date: date,
            dayHours: document.getElementById('logDay').value,
            nightHours: document.getElementById('logNight').value,
            memo: document.getElementById('logMemo').value,
            workerId: currentWorkerId, // ë‹‰ë„¤ì„ê³¼ ì—°ë™
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        // ë‹‰ë„¤ì„_ë‚ ì§œ ì¡°í•©ìœ¼ë¡œ ë¬¸ì„œ ID ìƒì„± (ë®ì–´ì“°ê¸° ê°€ëŠ¥)
        db.collection('work_logs').doc(`${currentWorkerId}_${date}`).set(data)
        .then(() => {
            alert("âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            document.getElementById('logDay').value = "";
            document.getElementById('logNight').value = "";
            document.getElementById('logMemo').value = "";
        })
        .catch((error) => {
            console.error("Error writing document: ", error);
            alert("ì €ì¥ ì‹¤íŒ¨");
        });
    }

    // (4) ë‚´ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ë¡œê·¸ì¸ ì‹œ ìë™ ì‹¤í–‰)
    function loadMyLogs() {
        if(!currentWorkerId) return;

        db.collection('work_logs')
          .where('workerId', '==', currentWorkerId)
          .orderBy('date', 'desc')
          .limit(10) // ìµœê·¼ 10ê°œë§Œ í‘œì‹œ
          .onSnapshot(snapshot => {
              const list = document.getElementById('workLogList');
              list.innerHTML = "";
              snapshot.forEach(doc => {
                  const d = doc.data();
                  list.innerHTML += `
                  <li class="post-item" style="font-size:0.9rem;">
                      <strong>${d.date}</strong><br>
                      â˜€ï¸ì£¼ê°„: ${d.dayHours || 0}H / ğŸŒ™ì•¼ê°„: ${d.nightHours || 0}H<br>
                      ğŸ“ ${d.memo || '-'}
                  </li>`;
              });
          });
    }

    function closeModal() {
        document.getElementById('loginModal').style.display = 'none';
        document.getElementById('modalPw').value = ""; 
    }


    /* ========== ê¸°íƒ€ ê¸°ëŠ¥ (ê³µì§€, ê²Œì‹œíŒ ë“±) ========== */
    
    function toggleDarkMode(){ document.body.classList.toggle("dark-mode"); }
    
    async function verifyAdmin(){ 
        return prompt("ê´€ë¦¬ì ë¹„ë²ˆ:") === "1234"; // ì„ì‹œ ë¹„ë²ˆ
    }

    // ê³µì§€ì‚¬í•­
    function addNotice(){ verifyAdmin().then(isAuth => { if(isAuth) {
        db.collection("notices").add({
            title: document.getElementById('noticeTitle').value,
            content: document.getElementById('noticeContent').value,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(()=>alert("ë“±ë¡ë¨"));
    }})}
    
    function loadNotices(){
        db.collection("notices").orderBy("timestamp","desc").onSnapshot(s => {
            const l = document.getElementById('noticeList'); l.innerHTML="";
            s.forEach(d => { l.innerHTML+=`<li class="post-item"><b>${d.data().title}</b><br>${d.data().content}</li>`; });
        });
    }

    // ê²Œì‹œíŒ
    function addPost(){
        db.collection("posts").add({
            title: document.getElementById('postTitle').value,
            content: document.getElementById('postContent').value,
            password: document.getElementById('postPw').value,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(()=>alert("ë“±ë¡ë¨"));
    }
    
    function loadPosts(){
        db.collection("posts").orderBy("timestamp","desc").onSnapshot(s => {
            const l = document.getElementById('boardList'); l.innerHTML="";
            s.forEach(d => { l.innerHTML+=`<li class="post-item"><b>${d.data().title}</b><br>${d.data().content}</li>`; });
        });
    }

    // ì„ ë°•
    function addShipInfo(){
        const name = document.getElementById('shipName').value;
        if(name) db.collection("ships").doc(name).set({
            name: name, onboard: document.getElementById('shipOnboard').value,
            updated: firebase.firestore.FieldValue.serverTimestamp()
        }).then(()=>alert("ì €ì¥ë¨"));
    }
    
    function loadShips(){
        db.collection("ships").orderBy("updated","desc").onSnapshot(s => {
            allShipsData=[]; s.forEach(d => allShipsData.push(d.data()));
            filterShips(); 
        });
    }
    
    function filterShips(){
        const q = document.getElementById('shipSearch').value.toLowerCase();
        const list = document.getElementById('shipList'); list.innerHTML="";
        allShipsData.filter(s => s.name.toLowerCase().includes(q)).forEach(s => {
            list.innerHTML+=`<li class="post-item"><b>${s.name}</b><br>${s.onboard}</li>`;
        });
    }

    // ìë£Œì‹¤
    function uploadFile(){
        const f = document.getElementById('fileInput').files[0];
        if(f) storage.ref("files/"+Date.now()+"_"+f.name).put(f).then(s => s.ref.getDownloadURL())
        .then(u => db.collection("archives").add({
            title: document.getElementById('fileTitle').value, url: u, timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })).then(()=>alert("ì—…ë¡œë“œë¨"));
    }
    
    function loadFiles(){
        db.collection("archives").orderBy("timestamp","desc").onSnapshot(s => {
            const l = document.getElementById('fileList'); l.innerHTML="";
            s.forEach(d => { l.innerHTML+=`<li class="post-item"><a href="${d.data().url}" target="_blank">${d.data().title}</a></li>`; });
        });
    }

    // ìœ í‹¸ë¦¬í‹°: í† ê¸€
    function toggleContent(element) {
        const content = element.nextElementSibling;
        if (content) {
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
        }
    }

    // ì´ˆê¸°í™”
    window.onload = function() {
        document.getElementById('logDate').valueAsDate = new Date();
        loadNotices();
        loadPosts();
        loadShips();
        loadFiles();
    };
</script>
</body>
</html>  
